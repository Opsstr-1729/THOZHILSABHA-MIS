<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASE Placement 2026 | MIS Executive Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&family=Noto+Serif+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --teal: #0e5774;
            --gold: #E1AD01;
            --bg: #f4f7f9;
            --white: #ffffff;
            --text: #0f172a;
        }

        body { font-family: 'Noto Sans', sans-serif; background-color: var(--bg); margin: 0; padding: 25px; color: var(--text); }
        header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-family: 'Noto Serif Condensed', serif; color: var(--teal); font-size: 2.2rem; margin: 0; }

        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 24px; border-radius: 16px; border-bottom: 4px solid var(--gold); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .stat-card h3 { margin: 0; font-size: 0.75rem; color: var(--teal); text-transform: uppercase; letter-spacing: 0.1em; }
        .stat-card .value { font-size: 2.2rem; font-weight: 800; margin-top: 8px; font-family: 'Noto Serif Condensed', serif; }

        .sync-btn { background: var(--teal); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .sync-btn:hover { background: #167ba3; }

        .analytics-main { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 40px; }
        .panel-wrapper { background: var(--white); padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 380px; }
        .panel-header { font-family: 'Noto Serif Condensed', serif; color: var(--teal); font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; border-bottom: 2px solid var(--gold); padding-bottom: 8px; text-transform: uppercase; }

        .scroll-container { max-height: 280px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-family: 'Noto Serif Condensed', serif; }
        th { background: var(--teal); color: var(--white); text-align: left; padding: 12px; font-size: 0.85rem; position: sticky; top: 0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 1rem; }

        .collapse-btn { width: 100%; background: var(--teal); color: white; padding: 18px 25px; border: none; border-radius: 12px; font-family: 'Noto Serif Condensed', serif; font-size: 1.2rem; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .collapse-content { display: none; background: var(--white); border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden; margin-bottom: 40px; }
        .collapse-content.active { display: block; }
        .highlight-row { background-color: #fff9c4 !important; }
        tr.clickable-row:hover { background-color: #f1f5f9; cursor: pointer; }

        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(8px); }
        .modal-content { background: white; margin: 5% auto; padding: 40px; width: 90%; max-width: 650px; border-radius: 24px; border-top: 10px solid var(--teal); }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        .detail-item label { font-size: 0.75rem; color: var(--teal); font-weight: 800; text-transform: uppercase; }
        .detail-item p { margin: 4px 0 0 0; font-size: 1.1rem; color: var(--text); }
    </style>
</head>
<body>

    <header>
        <h1>KASE à´¤àµŠà´´à´¿àµ½à´®àµ‡à´³ Dashboard</h1>
        <button class="sync-btn" onclick="refreshDashboard()">
            <span id="syncIcon">ðŸ”„</span> SYNC
        </button>
    </header>

    <div class="analytics-grid">
        <div class="stat-card"><h3>Registrations</h3><div class="value" id="totalReg">0</div></div>
        <div class="stat-card"><h3>Verified Present</h3><div class="value" id="attendCount">0</div></div>
        <div class="stat-card"><h3>Experienced Pool</h3><div class="value" id="expCount">0</div></div>
        <div class="stat-card"><h3>PWD Support</h3><div class="value" id="pwdCount">0</div></div>
    </div>

    <div class="analytics-main">
        <div class="panel-wrapper">
            <div class="panel-header">Gender Demographics</div>
            <div style="height: 300px;"><canvas id="genderChart"></canvas></div>
        </div>
        <div class="panel-wrapper">
            <div class="panel-header">District Breakdown</div>
            <div class="scroll-container">
                <table>
                    <thead>
                        <tr><th>District</th><th>Count</th><th>%</th></tr>
                    </thead>
                    <tbody id="districtTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <button class="collapse-btn" onclick="toggleCollapse()">
        <span>CANDIDATE AUDIT PROFILE</span>
        <span id="arrow">â–¼</span>
    </button>
    <div id="candidateData" class="collapse-content">
        <div style="overflow-x: auto;">
            <table style="min-width: 1000px; table-layout: fixed;">
                <thead>
                    <tr><th style="width: 15%">ID</th><th style="width: 25%">Name</th><th style="width: 20%">District</th><th style="width: 20%">Qualification</th><th style="width: 20%">Emp Status</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="drillDownModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="mName" style="color: var(--teal); font-family: 'Noto Serif Condensed', serif;">Candidate Record</h2>
            <div class="detail-grid" id="mDetails"></div>
            <button onclick="closeModal()" style="margin-top:30px; padding:12px 24px; background:var(--teal); color:white; border:none; border-radius:8px; cursor:pointer;">DISMISS</button>
        </div>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR7yGVpCvEDWTV3-qKLCmnb_n5AO-wgu1-SjRZ7M5QbohrI2uy77q9qCwxGwwDV11HSebe146TZUeC-/pub?output=csv";
        let genderChart, masterData;

        function parseCSV(text) {
            return text.split('\n').slice(1).filter(l => l.trim()).map(line => {
                const res = []; let cell = '', inQuotes = false;
                for (let char of line) {
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) { res.push(cell.trim()); cell = ''; }
                    else cell += char;
                }
                res.push(cell.trim()); return res;
            });
        }

        async function refreshDashboard() {
            const btn = document.getElementById('syncIcon');
            btn.style.display = "inline-block";
            btn.animate([{ transform: 'rotate(0deg)' }, { transform: 'rotate(360deg)' }], { duration: 1000, iterations: 1 });

            try {
                // Fetch with a unique timestamp to force Google to provide the freshest data available
                const res = await fetch(`${CSV_URL}&t=${Date.now()}`);
                const data = parseCSV(await res.text());
                masterData = data;
                
                document.getElementById('totalReg').innerText = data.length;
                // Index 34 is Column AI (Attendance)
                document.getElementById('attendCount').innerText = data.filter(r => r[34] && r[34].includes("PRESENT")).length;
                document.getElementById('expCount').innerText = data.filter(r => r[19] === "Experienced").length;
                document.getElementById('pwdCount').innerText = data.filter(r => r[29] === "Yes").length;

                renderDistrictTable(data);
                renderMasterTable(data);
                renderGenderChart(data);
            } catch (err) { console.error("Sync Error", err); }
        }

        function renderDistrictTable(data) {
            const counts = {};
            data.forEach(r => { counts[r[13]] = (counts[r[13]] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            document.getElementById('districtTableBody').innerHTML = sorted.map(([name, count]) => `
                <tr><td>${name || 'Unspecified'}</td><td><strong>${count}</strong></td><td>${((count/data.length)*100).toFixed(1)}%</td></tr>
            `).join('');
        }

        function renderMasterTable(data) {
            document.getElementById('tableBody').innerHTML = data.map((row, i) => `
                <tr onclick="openModal(${i})" class="clickable-row ${row[19] === 'Experienced' ? 'highlight-row' : ''}">
                    <td>${row[0]}</td><td>${row[2]}</td><td>${row[13]}</td><td>${row[15]}</td><td>${row[19]}</td>
                </tr>
            `).join('');
        }

        function renderGenderChart(data) {
            const counts = {};
            data.forEach(r => { counts[r[3]] = (counts[r[3]] || 0) + 1; });
            if (genderChart) genderChart.destroy();
            genderChart = new Chart(document.getElementById('genderChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{ data: Object.values(counts), backgroundColor: ['#0e5774', '#E1AD01', '#cbd5e1'] }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function toggleCollapse() {
            const content = document.getElementById('candidateData');
            const arrow = document.getElementById('arrow');
            content.classList.toggle('active');
            arrow.innerText = content.classList.contains('active') ? 'â–²' : 'â–¼';
        }

        function openModal(idx) {
            const r = masterData[idx];
            document.getElementById('mName').innerText = r[2];
            document.getElementById('mDetails').innerHTML = `
                <div class="detail-item"><label>Contact</label><p>${r[6]}</p></div>
                <div class="detail-item"><label>Email</label><p>${r[8]}</p></div>
                <div class="detail-item"><label>Attendance</label><p>${r[34] || 'NOT MARKED'}</p></div>
                <div class="detail-item"><label>Exp Salary</label><p>${r[23]}</p></div>
            `;
            document.getElementById('drillDownModal').style.display = 'block';
        }

        function closeModal() { document.getElementById('drillDownModal').style.display = 'none'; }

        refreshDashboard();
        setInterval(refreshDashboard, 60000);
    </script>
</body>
</html>
